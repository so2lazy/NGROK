name: Windows RDP with ngrok
on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    steps:
      - name: Enable RDP and Setup User
        shell: powershell
        run: |
          # Включаем RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          # Создаем пользователя (Пароль: Dahood2525!)
          net user rdpuser "Dahood2525!" /add
          net localgroup administrators rdpuser /add
          Write-Host "User rdpuser created and added to Admins."

      - name: Install and Config ngrok
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath .
          .\ngrok.exe config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Start ngrok tunnel
        shell: powershell
        run: |
          # Запускаем ngrok с явным указанием логирования в файл
          Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389 --log=stdout" -RedirectStandardOutput "ngrok.log"
          Start-Sleep -Seconds 15

      - name: Show RDP Address
        shell: powershell
        run: |
          # Самый надежный метод — тянуть адрес из API самого ngrok
          $ngrok_api = Invoke-RestMethod http://localhost:4040/api/tunnels
          $address = $ngrok_api.tunnels.public_url
          if ($address) {
              Write-Host "-------------------------------------------"
              Write-Host "RDP ADDRESS: $address"
              Write-Host "User: rdpuser"
              Write-Host "Pass: Dahood252525!"
              Write-Host "-------------------------------------------"
          } else {
              Write-Error "Ngrok address not found. Check your Token!"
              Get-Content ngrok.log
          }

      - name: Keep alive
        shell: powershell
        run: |
          Write-Host "RDP is ready. Connect now!"
          while ($true) { Start-Sleep -Seconds 300 }
