name: Windows RDP (Tmate Edition)
on:
  workflow_dispatch: # Запуск кнопкой

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Setup RDP and User
        shell: powershell
        run: |
          # Включаем RDP и настраиваем брандмауэр
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 0
          
          # Создаем юзера (Пароль: Dahood2525!)
          net user rdpuser "Dahood2525!" /add
          net localgroup administrators rdpuser /add
          Write-Host "RDP user created."

      - name: Install Tmate
        shell: powershell
        run: |
          # Используем менеджер пакетов choco для быстрой установки
          choco install tmate -y

      - name: Start Tmate Tunnel
        shell: powershell
        run: |
          # Генерируем SSH ключи (нужно для работы tmate)
          ssh-keygen -t rsa -f "$env:USERPROFILE\.ssh\id_rsa" -N ""
          
          # Запускаем tmate в фоновом режиме
          Start-Process -FilePath "tmate" -ArgumentList "-S /tmp/tmate.sock new-session -d"
          Start-Sleep -Seconds 5
          tmate -S /tmp/tmate.sock wait tmate-ready
          
          # Получаем строку подключения
          $tmate_ssh = tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}'
          Write-Host "-------------------------------------------------------"
          Write-Host "SSH TUNNEL: $tmate_ssh"
          Write-Host "-------------------------------------------------------"
          
          # Подсказка для проброса порта
          $clean_ssh = $tmate_ssh.Replace("ssh ", "")
          Write-Host "COMMAND TO CONNECT FROM YOUR PC:"
          Write-Host "ssh -L 33890:localhost:3389 $clean_ssh"
          Write-Host "-------------------------------------------------------"

      - name: Keep Alive
        shell: powershell
        run: |
          Write-Host "RDP is active. Don't close this tab."
          while ($true) { Start-Sleep -Seconds 3600 }
